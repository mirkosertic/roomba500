<html>
    <head>
        <title>Roomba Remote Control</title>
        <style>
            .controlcontainer {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 2rem 2rem 2rem 2rem 2rem 2rem 2rem 2rem;
                gap: 0.5rem 0.5rem;
                grid-template-areas:
    "wakeup . shutdown"
    "forwardleft forward forwardright"
    "left stop right"
    ". backward ."
    ". relocalization ."
    ". clean ."
    ". cancel .";
                width: 50rem;
            }

            .wakeupbutton {
                grid-area: wakeup;
            }

            .shutdownbutton {
                grid-area: shutdown;
            }

            .leftbutton {
                grid-area: left;
            }

            .rightbutton {
                grid-area: right;
            }

            .stopbutton {
                grid-area: stop;
            }

            .forwardbutton {
                grid-area: forward;
            }

            .forwardleftbutton {
                grid-area: forwardleft;
            }

            .forwardrightbutton {
                grid-area: forwardright;
            }

            .backwardbutton {
                grid-area: backward;
            }

            .relocalizatiobutton {
                grid-area: relocalization;
            }

            .cleanbutton {
                grid-area: clean;
            }

            .cancelbutton {
                grid-area: cancel;
            }

            .sensorcontainer {
                display: grid;
                visibility: hidden;
                grid-template-columns: auto auto auto auto auto auto;
                grid-template-rows: auto 1rem auto auto;
                gap: 0 0;
                grid-template-areas:
    ". bumperLeft . . bumperRight ."
    "lightFrontLeft . lightCenterLeft lightCenterRight . lightFrontRight"
    ". . commonstatus commonstatus . ."
    "lightLeft . . . . lightRight";
                width: 55rem;
                height: 30rem;
            }

            .commonstatus {
                grid-area: commonstatus;
                align-self: center;
                text-align: center;
            }

            .statusLED {
                width: 2em;
                height: 2em;
                border-radius: 50%;
                background-color: green;
                text-align: center;
                align-self: center;
            }

            .statusLED[data-status='false'] {
                border: 2px solid black;
                background-color: green;
            }

            .statusLED[data-status='true'] {
                border: 2px solid black;
                background-color: red;
            }

            .lightSensor::before {
                content: attr(data-value);
            }

            .lightSensor {
                width: 4rem;
                border: 1px solid black;
                text-align: center;
            }

            .bumperLeft {
                grid-area: bumperLeft;
                align-self: center;
            }

            .bumperRight {
                grid-area: bumperRight;
                align-self: center;
            }

            .lightsensorLeft {
                grid-area: lightLeft;
                align-self: center;
            }

            .lightsensorFrontLeft {
                grid-area: lightFrontLeft;
                align-self: center;
            }

            .lightsensorCenterLeft {
                grid-area: lightCenterLeft;
                align-self: center;
            }

            .lightsensorCenterRight {
                grid-area: lightCenterRight;
                align-self: center;
            }

            .lightsensorFrontRight {
                grid-area: lightFrontRight;
                align-self: center;
            }

            .lightsensorRight {
                grid-area: lightRight;
                align-self: center;
            }

            #roomcontainer {
                padding-left: 0.1rem;
                padding-top: 0.1rem;
                padding-bottom: 1rem;
            }

            #roomcontainer {
                display: block;
            }

            #roomlist span {
                display: block;
                padding-top: 0.1rem;
                padding-bottom: 0.1rem;
            }

            #roomlist .caption {
                padding-right: 1rem;
            }
        </style>
    </head>
    <body>
        <h1>Roomba Remote</h1>

        <div id='roomcontainer'>
            <h2>Start robot in room:</h2>
            <div id='roomlist'>
            </div>
        </div>

        <div class='controlcontainer'>
            <input class='wakeupbutton' id='wakeupbutton' type='submit' value='Start in new Room'/>
            <input class='shutdownbutton' id='shutdownbutton' type='submit' value='Shutdown'/>
            <input class='leftbutton' id='leftbutton' type='submit' value='Turn Left'/>
            <input class='stopbutton' id='stopbutton' type='submit' value='Stop'/>
            <input class='rightbutton' id='rightbutton' type='submit' value='Turn Right'/>
            <input class='forwardleftbutton' id='forwardleftbutton' type='submit' value='Forward-Left'/>
            <input class='forwardbutton' id='forwardbutton' type='submit' value='Forward'/>
            <input class='forwardrightbutton' id='forwardrightbutton' type='submit' value='Forward-Right'/>
            <input class='backwardbutton' id='backwardbutton' type='submit' value='Backward'/>
            <input class='relocalizatiobutton' id='relocalizatiobutton' type='submit' value='Relocalization'/>
            <input class='cleanbutton' id='cleanbutton' type='submit' value='Clean'/>
            <input class='cancelbutton' id='cancelbutton' type='submit' value='Cancel'/>
        </div>

        <div id='sensorcontainer' class='sensorcontainer'>
            <div id='bumperleft' class='bumperLeft statusLED' data-status='true'></div>
            <div id='bumperright' class='bumperRight statusLED' data-status='false'></div>
            <div id='lightsensorLeft' class='lightsensorLeft lightSensor' data-value="0"></div>
            <div id='lightsensorFrontLeft' class='lightsensorFrontLeft lightSensor' data-value="0"></div>
            <div id='lightsensorCenterLeft' class='lightsensorCenterLeft lightSensor' data-value="0"></div>
            <div id='lightsensorCenterRight' class='lightsensorCenterRight lightSensor' data-value="0"></div>
            <div id='lightsensorFrontRight' class='lightsensorFrontRight lightSensor' data-value="0"></div>
            <div id='lightsensorRight' class='lightsensorRight lightSensor' data-value="0"></div>
            <div class='roomba'></div>
            <div class='commonstatus' >Battery : <span id='batteryCharge'>&nbsp;</span> mAH / <span id='batteryCapacity'>&nbsp;</span> mAH<br>Left Wheel Encoder : <span id='leftWheelEncoder'> </span> Ticks / Right Wheel Encoder : <span id='rightWheelEncoder'> </span> Ticks<br>Stopwatch: <span id='stopwatch'>0</span> ms<br>Vel X Commanded/Real : <span id='velxstatus'>1/2 </span> m/s<br>Vel Theta Commanded/Real : <span id='velthetastatus'>1/2 </span> rad/s<br>Distance to target : <span id='distancetotarget'>1/2 </span> m<br>Angle to target : <span id='angletotarget'>1/2 </span> degrees</div>
        </div>

        <script>
            let roomcontainer = document.getElementById('roomcontainer');
            let roomlist = document.getElementById('roomlist');

            let sensorcontainer = document.getElementById('sensorcontainer');

            let wakeupButton = document.getElementById('wakeupbutton');
            let shutdownButton = document.getElementById('shutdownbutton');
            let batteryCharge = document.getElementById('batteryCharge');
            let batteryCapacity = document.getElementById('batteryCapacity');
            let leftbutton = document.getElementById('leftbutton');
            let rightbutton = document.getElementById('rightbutton');
            let forwardleftbutton = document.getElementById('forwardleftbutton');
            let forwardbutton = document.getElementById('forwardbutton');
            let forwardrightbutton = document.getElementById('forwardrightbutton');
            let stopbutton = document.getElementById('stopbutton');
            let backwardbutton = document.getElementById('backwardbutton');
            let relocalizatiobutton = document.getElementById('relocalizatiobutton');
            let cleanbutton = document.getElementById('cleanbutton');
            let cancelbutton = document.getElementById('cancelbutton');

            let leftWheelEncoder = document.getElementById('leftWheelEncoder');
            let rightWheelEncoder = document.getElementById('rightWheelEncoder');
            let velxstatus = document.getElementById('velxstatus');
            let velthetastatus = document.getElementById('velthetastatus');
            let distancetotarget = document.getElementById('distancetotarget');
            let angletotarget = document.getElementById('angletotarget');

            let bumperleft = document.getElementById('bumperleft');
            let bumperright = document.getElementById('bumperright');
            let lightsensorLeft = document.getElementById('lightsensorLeft');
            let lightsensorFrontLeft = document.getElementById('lightsensorFrontLeft');
            let lightsensorCenterLeft = document.getElementById('lightsensorCenterLeft');
            let lightsensorCenterRight = document.getElementById('lightsensorCenterRight');
            let lightsensorFrontRight = document.getElementById('lightsensorFrontRight');
            let lightsensorRight = document.getElementById('lightsensorRight');

            let stopwatch = document.getElementById('stopwatch');

            let uistate = {
                starttime : undefined,
            }

            function updateStopwatch() {
                if (uistate.starttime > 0) {
                    let delta = Date.now() - uistate.starttime;
                    stopwatch.innerText = '' + delta;
                }
            }

            function percentage(real, expected) {
                if (expected === 0.0) {
                    return '-';
                }
                if (real === 0.0) {
                    return ' Err '
                }
                return (real / expected * 100).toFixed(1) + ' %';
            }

            function loadRoom(roomName) {
                fetch('/actions/room/' + roomName + '/start').then(response => fetchState());
            }

            function deleteRoom(roomName) {
                fetch('/actions/room/' + roomName + '/delete').then(response => fetchState());
            }

            function updateUI(data) {
                roomlist.textContent = '';
                if (data.awake) {
                    roomcontainer.style.display = 'none';
                    sensorcontainer.style.visibility = 'visible';

                    batteryCharge.innerText = '' + data.batteryCharge;
                    batteryCapacity.innerText = '' + data.batteryCapacity;
                    wakeupButton.disabled = true;
                    shutdownButton.disabled = false;
                    leftbutton.disabled = false;
                    rightbutton.disabled = false;
                    forwardleftbutton.disabled = false;
                    forwardbutton.disabled = false;
                    forwardrightbutton.disabled = false;
                    stopbutton.disabled = false;
                    backwardbutton.disabled = false;
                    relocalizatiobutton.disabled = !data.amclmode;
                    cleanbutton.disabled = false;
                    cancelbutton.disabled = false;

                    bumperleft.dataset.status = '' + data.bumperLeft;
                    bumperright.dataset.status = '' + data.bumperRight;

                    lightsensorLeft.dataset.value = '' + data.lightbumperLeft;
                    lightsensorFrontLeft.dataset.value = '' + data.lightbumperFrontLeft;
                    lightsensorCenterLeft.dataset.value = '' + data.lightbumperCenterLeft;
                    lightsensorCenterRight.dataset.value = '' + data.lightbumperCenterRight;
                    lightsensorFrontRight.dataset.value = '' + data.lightbumperFrontRight;
                    lightsensorRight.dataset.value = '' + data.lightbumperRight;

                    leftWheelEncoder.innerText = '' + data.wheelEncoderLeft;
                    rightWheelEncoder.innerText = '' + data.wheelEncoderRight;

                    velxstatus.innerText = '' + data.lastcommandedvelx.toFixed(3) + ' / ' + data.odomvelx.toFixed(3) + ' (' + percentage(data.odomvelx, data.lastcommandedvelx) + ')';
                    velthetastatus.innerText = '' + data.lastcommandedveltheta.toFixed(3) + ' / ' + data.odomveltheta.toFixed(3) + ' (' + percentage(data.odomveltheta, data.lastcommandedveltheta) + ')';

                    distancetotarget.innerText = '' + data.distanceToTargetInMeters.toFixed(2);
                    angletotarget.innerText = '' + data.angleToTargetInDegrees.toFixed(2);

                    updateStopwatch()

                } else {
                    for (let r of data.rooms) {
                        let l = document.createElement("span");

                        let cap = document.createElement("a");
                        cap.classList.add('caption');
                        cap.innerText = r;
                        cap.onclick = function(event) {
                            loadRoom(r);
                        };
                        l.append(cap);

                        let action = document.createElement("a");
                        action.classList.add('delete');
                        action.innerText = 'Delete';
                        action.onclick = function(event) {
                            deleteRoom(r);
                        };
                        l.append(action);

                        roomlist.appendChild(l);
                    }
                    sensorcontainer.style.visibility = 'hidden';

                    wakeupButton.disabled = false;
                    shutdownButton.disabled = true;
                    leftbutton.disabled = true;
                    rightbutton.disabled = true;
                    forwardleftbutton.disabled = true;
                    forwardbutton.disabled = true;
                    forwardrightbutton.disabled = true;
                    stopbutton.disabled = true;
                    relocalizatiobutton.disabled = true;
                    backwardbutton.disabled = true;
                    cleanbutton.disabled = true;
                    cancelbutton.disabled = true;
                }
            }

            function fetchState() {
                fetch('/systemstate.json')
                    .then(response => response.json())
                    .then(data => updateUI(data))
                    .catch(function(error) {
                        updateUI({
                            awake: false,
                            batteryCharge: '100',
                            batteryCapacity: '200',
                            bumperLeft: false,
                            bumperRight: false,
                            lightbumperLeft: 1,
                            lightbumperFrontLeft: 2,
                            lightbumperCenterLeft: 3,
                            lightbumperCenterRight: 4,
                            lightbumperFrontRight: 5,
                            lightbumperRight: 6,
                            amclmode: true,
                            wheelEncoderLeft: 18,
                            wheelEncoderRight: 19,
                            lastcommandedvelx: 0.2,
                            lastcommandedveltheta: 1.2,
                            odomvelx: 0.19,
                            odomveltheta: 1.1,
                            distanceToTargetInMeters: 87,
                            angleToTargetInDegrees: 99,
                            rooms: ['room01', 'room02']
                        })
                    })
            }

            function wakeup() {
                fetch('/actions/startnewroom').then(response => fetchState());
            }

            function shutdown() {
                fetch('/actions/shutdown').then(response => fetchState());
            }

            function turnleft() {
                uistate.starttime = Date.now()
                fetch('/actions/turnleft').then(response => fetchState());
            }

            function turnright() {
                uistate.starttime = Date.now()
                fetch('/actions/turnright').then(response => fetchState());
            }

            function stop() {
                fetch('/actions/stop').then(response => fetchState());
                updateStopwatch()
                uistate.starttime = undefined
            }

            function forwardleft() {
                uistate.starttime = Date.now()
                fetch('/actions/forwardleft').then(response => fetchState());
            }

            function forward() {
                uistate.starttime = Date.now()
                fetch('/actions/forward').then(response => fetchState());
            }

            function forwardright() {
                uistate.starttime = Date.now()
                fetch('/actions/forwardright').then(response => fetchState());
            }

            function backward() {
                uistate.starttime = Date.now()
                fetch('/actions/backward').then(response => fetchState());
            }

            function relocalization() {
                fetch('/actions/relocalization').then(response => fetchState());
            }

            function clean() {
                fetch('/actions/clean').then(response => fetchState());
            }

            function cancel() {
                fetch('/actions/cancel').then(response => fetchState());
            }

            wakeupButton.addEventListener('click', wakeup);
            shutdownButton.addEventListener('click', shutdown);

            leftbutton.addEventListener('click', turnleft);
            rightbutton.addEventListener('click', turnright);
            stopbutton.addEventListener('click', stop);
            forwardleftbutton.addEventListener('click', forwardleft);
            forwardbutton.addEventListener('click', forward);
            forwardrightbutton.addEventListener('click', forwardright);
            backwardbutton.addEventListener('click', backward);

            relocalizatiobutton.addEventListener('click', relocalization);
            cleanbutton.addEventListener('click', clean);
            cancelbutton.addEventListener('click', cancel);

            fetchState();
            setInterval(fetchState, 2000);

        </script>
    </body>
</html>