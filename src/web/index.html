<html>
    <head>
        <title>Roomba Remote Control</title>
        <style>
            .controlcontainer {
                display: grid;
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 2rem 2rem 2rem 2rem 2rem 2rem 2rem 2rem 2rem;
                gap: 0.5rem 0.5rem;
                grid-template-areas:
    "wakeup . shutdown"
    "forwardleft forward forwardright"
    "left stop right"
    ". backward ."
    ". relocalization ."
    ". clean ."
    ". cancel ."
    ". simulate .";
                width: 50rem;
            }

            .wakeupbutton {
                grid-area: wakeup;
            }

            .shutdownbutton {
                grid-area: shutdown;
            }

            .leftbutton {
                grid-area: left;
            }

            .rightbutton {
                grid-area: right;
            }

            .stopbutton {
                grid-area: stop;
            }

            .forwardbutton {
                grid-area: forward;
            }

            .forwardleftbutton {
                grid-area: forwardleft;
            }

            .forwardrightbutton {
                grid-area: forwardright;
            }

            .backwardbutton {
                grid-area: backward;
            }

            .relocalizatiobutton {
                grid-area: relocalization;
            }

            .cleanbutton {
                grid-area: clean;
            }

            .cancelbutton {
                grid-area: cancel;
            }

            .simulatebutton {
                grid-area: simulate;
            }

            .sensorcontainer {
                display: grid;
                visibility: hidden;
                grid-template-columns: auto auto auto auto auto auto;
                grid-template-rows: auto 1rem auto auto;
                gap: 0 0;
                grid-template-areas:
    ". bumperLeft . . bumperRight ."
    "lightFrontLeft . lightCenterLeft lightCenterRight . lightFrontRight"
    ". . commonstatus commonstatus . ."
    "lightLeft . . . . lightRight";
                width: 55rem;
                height: 30rem;
            }

            .commonstatus {
                grid-area: commonstatus;
                align-self: center;
                text-align: center;
            }

            .statusLED {
                width: 2em;
                height: 2em;
                border-radius: 50%;
                background-color: green;
                text-align: center;
                align-self: center;
            }

            .statusLED[data-status='false'] {
                border: 2px solid black;
                background-color: green;
            }

            .statusLED[data-status='true'] {
                border: 2px solid black;
                background-color: red;
            }

            .lightSensor::before {
                content: attr(data-value);
            }

            .lightSensor {
                width: 4rem;
                border: 1px solid black;
                text-align: center;
            }

            .bumperLeft {
                grid-area: bumperLeft;
                align-self: center;
            }

            .bumperRight {
                grid-area: bumperRight;
                align-self: center;
            }

            .lightsensorLeft {
                grid-area: lightLeft;
                align-self: center;
            }

            .lightsensorFrontLeft {
                grid-area: lightFrontLeft;
                align-self: center;
            }

            .lightsensorCenterLeft {
                grid-area: lightCenterLeft;
                align-self: center;
            }

            .lightsensorCenterRight {
                grid-area: lightCenterRight;
                align-self: center;
            }

            .lightsensorFrontRight {
                grid-area: lightFrontRight;
                align-self: center;
            }

            .lightsensorRight {
                grid-area: lightRight;
                align-self: center;
            }

            #roomcontainer {
                padding-left: 0.1rem;
                padding-top: 0.1rem;
                padding-bottom: 1rem;
            }

            #roomcontainer {
                display: block;
            }

            #roomlist span {
                display: block;
                padding-top: 0.1rem;
                padding-bottom: 0.1rem;
            }

            #roomlist .caption {
                padding-right: 1rem;
            }

            #log {
                display: block;
                width: 100%;
                font-family: monospace;
                white-space: pre-line;
                padding-bottom: 0.5rem;
            }

            .canvaswrapper {
                position: relative;
                width: 10rem;
                height: 10rem;
            }

            .canvaswrapper canvas {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            #map {
                z-index: 10;
            }

            #interaction {
                z-index: 20;
            }
        </style>
        <script src="dummy.js"></script>
    </head>
    <body>
        <h1>Roomba Remote</h1>

        <div id="log"></div>

        <div class="canvaswrapper">
            <canvas id="map"></canvas>
            <canvas id="interaction"></canvas>
        </div>

        <div id='roomcontainer'>
            <h2>Start robot in room:</h2>
            <div id='roomlist'>
            </div>
        </div>

        <div class='controlcontainer'>
            <input class='wakeupbutton' id='wakeupbutton' type='submit' value='Start in new Room'/>
            <input class='shutdownbutton' id='shutdownbutton' type='submit' value='Shutdown'/>
            <input class='leftbutton' id='leftbutton' type='submit' value='Turn Left'/>
            <input class='stopbutton' id='stopbutton' type='submit' value='Stop'/>
            <input class='rightbutton' id='rightbutton' type='submit' value='Turn Right'/>
            <input class='forwardleftbutton' id='forwardleftbutton' type='submit' value='Forward-Left'/>
            <input class='forwardbutton' id='forwardbutton' type='submit' value='Forward'/>
            <input class='forwardrightbutton' id='forwardrightbutton' type='submit' value='Forward-Right'/>
            <input class='backwardbutton' id='backwardbutton' type='submit' value='Backward'/>
            <input class='relocalizatiobutton' id='relocalizatiobutton' type='submit' value='Relocalization'/>
            <input class='cleanbutton' id='cleanbutton' type='submit' value='Clean'/>
            <input class='cancelbutton' id='cancelbutton' type='submit' value='Cancel'/>
            <input class='simulatebutton' id='simulatebutton' type='submit' value='Simulate obstacle'/>
        </div>

        <div id='sensorcontainer' class='sensorcontainer'>
            <div id='bumperleft' class='bumperLeft statusLED' data-status='true'></div>
            <div id='bumperright' class='bumperRight statusLED' data-status='false'></div>
            <div id='lightsensorLeft' class='lightsensorLeft lightSensor' data-value="0"></div>
            <div id='lightsensorFrontLeft' class='lightsensorFrontLeft lightSensor' data-value="0"></div>
            <div id='lightsensorCenterLeft' class='lightsensorCenterLeft lightSensor' data-value="0"></div>
            <div id='lightsensorCenterRight' class='lightsensorCenterRight lightSensor' data-value="0"></div>
            <div id='lightsensorFrontRight' class='lightsensorFrontRight lightSensor' data-value="0"></div>
            <div id='lightsensorRight' class='lightsensorRight lightSensor' data-value="0"></div>
            <div class='roomba'></div>
            <div class='commonstatus' >Battery : <span id='batteryCharge'>&nbsp;</span> mAH / <span id='batteryCapacity'>&nbsp;</span> mAH<br>Left Wheel Encoder : <span id='leftWheelEncoder'> </span> Ticks / Right Wheel Encoder : <span id='rightWheelEncoder'> </span> Ticks<br>Stopwatch: <span id='stopwatch'>0</span> ms<br>Vel X Commanded/Real : <span id='velxstatus'>1/2 </span> m/s<br>Vel Theta Commanded/Real : <span id='velthetastatus'>1/2 </span> rad/s<br>Distance to target : <span id='distancetotarget'>1/2 </span> m<br>Angle to target : <span id='angletotarget'>1/2 </span> degrees<br>Waypoint <span id='currentwaypoint'>1</span> / <span id='numWaypoints'>1</span></div>
        </div>

        <script>
            let roomcontainer = document.getElementById('roomcontainer');
            let roomlist = document.getElementById('roomlist');

            let sensorcontainer = document.getElementById('sensorcontainer');

            let wakeupButton = document.getElementById('wakeupbutton');
            let shutdownButton = document.getElementById('shutdownbutton');
            let batteryCharge = document.getElementById('batteryCharge');
            let batteryCapacity = document.getElementById('batteryCapacity');
            let leftbutton = document.getElementById('leftbutton');
            let rightbutton = document.getElementById('rightbutton');
            let forwardleftbutton = document.getElementById('forwardleftbutton');
            let forwardbutton = document.getElementById('forwardbutton');
            let forwardrightbutton = document.getElementById('forwardrightbutton');
            let stopbutton = document.getElementById('stopbutton');
            let backwardbutton = document.getElementById('backwardbutton');
            let relocalizatiobutton = document.getElementById('relocalizatiobutton');
            let cleanbutton = document.getElementById('cleanbutton');
            let cancelbutton = document.getElementById('cancelbutton');
            let simulatebutton = document.getElementById('simulatebutton');

            let leftWheelEncoder = document.getElementById('leftWheelEncoder');
            let rightWheelEncoder = document.getElementById('rightWheelEncoder');
            let velxstatus = document.getElementById('velxstatus');
            let velthetastatus = document.getElementById('velthetastatus');
            let distancetotarget = document.getElementById('distancetotarget');
            let angletotarget = document.getElementById('angletotarget');
            let currentWaypoint = document.getElementById('currentwaypoint');
            let numWaypoints = document.getElementById('numWaypoints');

            let bumperleft = document.getElementById('bumperleft');
            let bumperright = document.getElementById('bumperright');
            let lightsensorLeft = document.getElementById('lightsensorLeft');
            let lightsensorFrontLeft = document.getElementById('lightsensorFrontLeft');
            let lightsensorCenterLeft = document.getElementById('lightsensorCenterLeft');
            let lightsensorCenterRight = document.getElementById('lightsensorCenterRight');
            let lightsensorFrontRight = document.getElementById('lightsensorFrontRight');
            let lightsensorRight = document.getElementById('lightsensorRight');

            let stopwatch = document.getElementById('stopwatch');

            let log = document.getElementById('log');
            let map = document.getElementById('map');
            let interaction = document.getElementById('interaction');
            interaction.width = interaction.clientWidth;
            interaction.height = interaction.clientHeight;

            let uistate = {
                starttime : undefined,
            }

            interaction.addEventListener('mousedown', function(event) {
                var rect = interaction.getBoundingClientRect();
                var x = event.clientX - rect.left;
                var y = event.clientY - rect.top;
                if (!interaction.hasAttribute("data-mousedown")) {
                    interaction.dataset.mousedown = true;
                    interaction.dataset.mousex = Math.floor(x);
                    interaction.dataset.mousey = Math.floor(y);
                }
            });
            interaction.addEventListener("mousemove", function(event) {
               if (interaction.hasAttribute("data-mousedown")) {
                   var rect = interaction.getBoundingClientRect();
                   let x = parseInt(interaction.dataset.mousex);
                   let y = parseInt(interaction.dataset.mousey);

                   var xm = event.clientX - rect.left; //x position within the element.
                   var ym = event.clientY - rect.top;  //y position within the element.

                   interaction.width = interaction.clientWidth;
                   interaction.height = interaction.clientHeight;

                   var context = interaction.getContext('2d');
                   context.strokeStyle = 'blue';
                   context.strokeRect(x, y, xm - x, ym - y);
               }
            });
            clearSelection = function(event) {
                interaction.removeAttribute("data-mousedown")
                interaction.removeAttribute("data-mousex");
                interaction.removeAttribute("data-mousey");

                interaction.width = interaction.clientWidth;
                interaction.height = interaction.clientHeight;
            };
            interaction.addEventListener("mouseup", clearSelection);
            interaction.addEventListener("mouseleave", clearSelection);

            function updateStopwatch() {
                if (uistate.starttime > 0) {
                    let delta = Date.now() - uistate.starttime;
                    stopwatch.innerText = '' + delta;
                }
            }

            function percentage(real, expected) {
                if (expected === 0.0) {
                    return '-';
                }
                if (real === 0.0) {
                    return ' Err '
                }
                return (real / expected * 100).toFixed(1) + ' %';
            }

            function loadRoom(roomName) {
                fetch('/actions/room/' + roomName + '/start').then(response => fetchState());
            }

            function deleteRoom(roomName) {
                fetch('/actions/room/' + roomName + '/delete').then(response => fetchState());
            }

            function updateUI(data) {
                roomlist.textContent = '';

                var logtext = '';
                for (let logmessage of data.log) {
                    const ts = new Date();
                    ts.setTime(Math.ceil(logmessage.stamp / 1000000));
                    level = '[UNDEF]';
                    switch (logmessage.level) {
                        case 1:
                            level = '[DEBUG]';
                            break;
                        case 2:
                            level = '[INFO ]';
                            break;
                        case 4:
                            level = '[WARN ]';
                            break;
                        case 8:
                            level = '[ERROR]';
                            break;
                        case 16:
                            level = '[FATAL]';
                            break;
                    }
                    logtext += new Intl.DateTimeFormat('en-US').format(ts) + ' ' + level + ' [' + logmessage.node + '] ' + logmessage.msg + '\n';
                }
                log.innerText = logtext;

                if (data.map) {
                    let width = data.map.width;
                    let height = data.map.height;
                    map.width = width;
                    map.height = height;
                    var context = map.getContext('2d');
                    var imageData = context.createImageData(width, height);
                    for (var row = 0; row < height; row++) {
                        for (var col = 0; col < width; col++) {
                            // determine the index into the map data
                            var mapI = width - col - 1 + (row * width);
                            // determine the value
                            var mapdata = data.map.data[mapI];
                            var val;
                            if (mapdata === 100) {
                                val = 0;
                            } else if (mapdata === 0) {
                                val = 255;
                            } else {
                                val = 127;
                            }

                            // determine the index into the image data array
                            var i = (col + (row * width)) * 4;
                            // r
                            imageData.data[i] = val;
                            // g
                            imageData.data[++i] = val;
                            // b
                            imageData.data[++i] = val;
                            // a
                            imageData.data[++i] = 255;
                        }
                    }
                    context.putImageData(imageData, 0, 0);

                    // Draw robot
                    if (data.odometryOnMap) {
                        let robotmapx = Math.floor((data.odometryOnMap.x - data.map.origin.x) / data.map.resolution);
                        let robotmapy = Math.floor((data.odometryOnMap.y - data.map.origin.y) / data.map.resolution);

                        dx = Math.floor(Math.sin(data.odometryOnMap.theta - Math.PI / 2) * 10);
                        dy = Math.floor(Math.cos(data.odometryOnMap.theta - Math.PI / 2) * 10);

                        context.fillstyle = 'red';
                        context.lineWidth = 1;
                        context.beginPath();
                        context.arc(map.width - robotmapx - 1, robotmapy, 2, 0, 2 * Math.PI, false);
                        context.fill();

                        context.moveTo(map.width - robotmapx - 1, robotmapy);
                        context.lineTo(map.width - robotmapx - 1 + dx, robotmapy + dy);
                        context.stroke();
                    }
                }

                if (data.awake) {
                    roomcontainer.style.display = 'none';
                    sensorcontainer.style.visibility = 'visible';

                    batteryCharge.innerText = '' + data.batteryCharge;
                    batteryCapacity.innerText = '' + data.batteryCapacity;
                    wakeupButton.disabled = true;
                    shutdownButton.disabled = false;
                    leftbutton.disabled = false;
                    rightbutton.disabled = false;
                    forwardleftbutton.disabled = false;
                    forwardbutton.disabled = false;
                    forwardrightbutton.disabled = false;
                    stopbutton.disabled = false;
                    backwardbutton.disabled = false;
                    relocalizatiobutton.disabled = !(data.hasrelocalization);
                    cleanbutton.disabled = !(data.hasclean);
                    cancelbutton.disabled = !(data.hascancel);

                    bumperleft.dataset.status = '' + data.bumperLeft;
                    bumperright.dataset.status = '' + data.bumperRight;

                    lightsensorLeft.dataset.value = '' + data.lightbumperLeft + ' ' + data.lightbumperLeftStat;
                    lightsensorFrontLeft.dataset.value = '' + data.lightbumperFrontLeft + ' ' + data.lightbumperFrontLeftStat;
                    lightsensorCenterLeft.dataset.value = '' + data.lightbumperCenterLeft + ' ' + data.lightbumperCenterLeftStat;
                    lightsensorCenterRight.dataset.value = '' + data.lightbumperCenterRight + ' ' + data.lightbumperCenterRightStat;
                    lightsensorFrontRight.dataset.value = '' + data.lightbumperFrontRight + ' ' + data.lightbumperFrontRightStat;
                    lightsensorRight.dataset.value = '' + data.lightbumperRight + ' ' + data.lightbumperRightStat;

                    leftWheelEncoder.innerText = '' + data.wheelEncoderLeft;
                    rightWheelEncoder.innerText = '' + data.wheelEncoderRight;

                    velxstatus.innerText = '' + data.lastcommandedvelx.toFixed(3) + ' / ' + data.odomvelx.toFixed(3) + ' (' + percentage(data.odomvelx, data.lastcommandedvelx) + ')';
                    velthetastatus.innerText = '' + data.lastcommandedveltheta.toFixed(3) + ' / ' + data.odomveltheta.toFixed(3) + ' (' + percentage(data.odomveltheta, data.lastcommandedveltheta) + ')';

                    distancetotarget.innerText = '' + data.distanceToTargetInMeters.toFixed(2);
                    angletotarget.innerText = '' + data.angleToTargetInDegrees.toFixed(2);

                    currentWaypoint.innerText = '' + data.currentWaypoint;
                    numWaypoints.innerText = '' + data.numWaypoints;

                    updateStopwatch()

                } else {
                    for (let r of data.rooms) {
                        let l = document.createElement("span");

                        let cap = document.createElement("a");
                        cap.classList.add('caption');
                        cap.innerText = r;
                        cap.onclick = function(event) {
                            loadRoom(r);
                        };
                        l.append(cap);

                        let action = document.createElement("a");
                        action.classList.add('delete');
                        action.innerText = 'Delete';
                        action.onclick = function(event) {
                            deleteRoom(r);
                        };
                        l.append(action);

                        roomlist.appendChild(l);
                    }
                    sensorcontainer.style.visibility = 'hidden';

                    wakeupButton.disabled = false;
                    shutdownButton.disabled = true;
                    leftbutton.disabled = true;
                    rightbutton.disabled = true;
                    forwardleftbutton.disabled = true;
                    forwardbutton.disabled = true;
                    forwardrightbutton.disabled = true;
                    stopbutton.disabled = true;
                    relocalizatiobutton.disabled = true;
                    backwardbutton.disabled = true;
                    cleanbutton.disabled = true;
                    cancelbutton.disabled = true;
                }
            }

            function fetchState() {
                fetch('/systemstate.json')
                    .then(response => response.json())
                    .then(data => updateUI(data))
                    .catch(function(error) {
                        updateUI(dummymapdata)
                    })
            }

            function wakeup() {
                fetch('/actions/startnewroom').then(response => fetchState());
            }

            function shutdown() {
                fetch('/actions/shutdown').then(response => fetchState());
            }

            function turnleft() {
                uistate.starttime = Date.now()
                fetch('/actions/turnleft').then(response => fetchState());
            }

            function turnright() {
                uistate.starttime = Date.now()
                fetch('/actions/turnright').then(response => fetchState());
            }

            function stop() {
                fetch('/actions/stop').then(response => fetchState());
                updateStopwatch()
                uistate.starttime = undefined
            }

            function forwardleft() {
                uistate.starttime = Date.now()
                fetch('/actions/forwardleft').then(response => fetchState());
            }

            function forward() {
                uistate.starttime = Date.now()
                fetch('/actions/forward').then(response => fetchState());
            }

            function forwardright() {
                uistate.starttime = Date.now()
                fetch('/actions/forwardright').then(response => fetchState());
            }

            function backward() {
                uistate.starttime = Date.now()
                fetch('/actions/backward').then(response => fetchState());
            }

            function relocalization() {
                fetch('/actions/relocalization').then(response => fetchState());
            }

            function clean() {
                fetch('/actions/clean').then(response => fetchState());
            }

            function cancel() {
                fetch('/actions/cancel').then(response => fetchState());
            }

            function simulateObstacle() {
                fetch('/actions/simulateObstacle').then(response => fetchState());
            }

            wakeupButton.addEventListener('click', wakeup);
            shutdownButton.addEventListener('click', shutdown);

            leftbutton.addEventListener('click', turnleft);
            rightbutton.addEventListener('click', turnright);
            stopbutton.addEventListener('click', stop);
            forwardleftbutton.addEventListener('click', forwardleft);
            forwardbutton.addEventListener('click', forward);
            forwardrightbutton.addEventListener('click', forwardright);
            backwardbutton.addEventListener('click', backward);

            relocalizatiobutton.addEventListener('click', relocalization);
            cleanbutton.addEventListener('click', clean);
            cancelbutton.addEventListener('click', cancel);
            simulatebutton.addEventListener('click', simulateObstacle);

            fetchState();
            setInterval(fetchState, 2000);

        </script>
    </body>
</html>